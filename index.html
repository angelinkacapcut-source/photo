<!DOCTYPE html><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ó–∞–ø–∏—Å—å 3:4 —Å–æ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–µ–π</title>
    <style>
        :root {
            --primary: #007bff;
            --danger: #ff4757;
            --success: #2ed573;
        }
        
        body { 
            font-family: -apple-system, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; background-color: #121212; color: white;
        }

        .video-wrapper {
            width: 90vw; max-width: 400px; aspect-ratio: 3 / 4; 
            background: #000; border-radius: 20px; overflow: hidden;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        video { width: 100%; height: 100%; object-fit: cover; }

        .controls { margin-top: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }

        button { 
            padding: 12px 20px; font-size: 14px; font-weight: 600; border: none;
            border-radius: 25px; cursor: pointer; transition: 0.2s;
        }

        #btnRecord { background: var(--primary); color: white; min-width: 140px; }
        #btnRecord.recording { background: var(--danger); animation: pulse 1.5s infinite; }

        #btnFlip, #btnStab { background: #333; color: white; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ */
        #btnStab.active { background: var(--success); color: black; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="video-wrapper">
        <video id="videoPreview" autoplay muted playsinline></video>
    </div>
    
    <div class="controls">
        <button id="btnFlip">üîÑ –ö–∞–º–µ—Ä–∞</button>
        <button id="btnStab">üì≥ –°—Ç–∞–±: –í–´–ö–õ</button>
        <button id="btnRecord">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>

    <script>
        const preview = document.getElementById('videoPreview');
        const btnRecord = document.getElementById('btnRecord');
        const btnFlip = document.getElementById('btnFlip');
        const btnStab = document.getElementById('btnStab');
        
        let mediaRecorder;
        let recordedChunks = [];
        let currentStream;
        let useFrontCamera = true;
        let isStabEnabled = false;

        async function startCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: useFrontCamera ? "user" : "environment",
                    width: { ideal: 1080 },
                    height: { ideal: 1440 },
                    aspectRatio: 0.75,
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤–∫–ª—é—á–∏—Ç—å —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
                    imageStabilizationMode: isStabEnabled ? "cinematic" : "off"
                },
                audio: true
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                preview.srcObject = currentStream;
                preview.style.transform = useFrontCamera ? "scaleX(-1)" : "scaleX(1)";
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏)
                const settings = currentStream.getVideoTracks()[0].getSettings();
                console.log("–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–µ–æ:", settings);
                
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞:", err);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
        btnStab.addEventListener('click', () => {
            isStabEnabled = !isStabEnabled;
            btnStab.innerText = isStabEnabled ? "‚úÖ –°—Ç–∞–±: –í–ö–õ" : "üì≥ –°—Ç–∞–±: –í–´–ö–õ";
            btnStab.classList.toggle('active');
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –∏–¥–µ—Ç –∑–∞–ø–∏—Å—å)
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                startCamera();
            }
        });

        btnFlip.addEventListener('click', () => {
            useFrontCamera = !useFrontCamera;
            startCamera();
        });

        btnRecord.addEventListener('click', () => {
            if (btnRecord.innerText === '–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å') {
                startRecording();
            } else {
                stopRecording();
            }
        });

        function startRecording() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(currentStream);
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = saveVideo;
            mediaRecorder.start();
            
            btnRecord.innerText = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            btnRecord.classList.add('recording');
            btnFlip.disabled = true;
            btnStab.disabled = true;
        }

        function stopRecording() {
            mediaRecorder.stop();
            btnRecord.innerText = '–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
            btnRecord.classList.remove('recording');
            btnFlip.disabled = false;
            btnStab.disabled = false;
        }

        function saveVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `video_${Date.now()}.webm`;
            a.click();
            URL.revokeObjectURL(url);
        }

        startCamera();
    </script>
</body>
</html>
